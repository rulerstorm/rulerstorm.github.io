<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 内存对齐浅析 · Rock's personal notebook</title><meta name="description" content="内存对齐浅析 - Rock Lu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/1565858217" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rulerstorm" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/impress/index.html" target="_self" class="nav-list-link">TEST</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">内存对齐浅析</h1><div class="post-time">Feb 14, 2016</div><div class="post-content"><p>这个概念经常听到，好像也不难。但是稍微想一下，就发现并不是一两句话能够带过的。</p>
<a id="more"></a>
<h4 id="啥是「字节对齐」？"><a href="#啥是「字节对齐」？" class="headerlink" title="啥是「字节对齐」？"></a>啥是「字节对齐」？</h4><p>变量放在内存中，以<code>起始位置</code>作为地址。内存对齐，就是把内存分出一个个的<code>“槽”</code>，看上去和分页差不多，称为对齐。</p>
<h4 id="为啥要对齐？"><a href="#为啥要对齐？" class="headerlink" title="为啥要对齐？"></a>为啥要对齐？</h4><p>现代机器虽然是「按字节编址」，理论上可以访问任意一个字节。但是，<code>somehow</code>32位机器通过地址总线访问内存时，总是从4Btye的<code>整数倍</code>位置开始。我们知道对于<code>字长</code>也是32位（4Byte）的计算机来说，一次读取的数据量就是4Byte。于是乎，如果一个Int型（4B）的数据，没有放在能被4B整除的位置，那么就需要访问两次（一前一后），才能拼出这个Int数据。所以，是<code>效率问题</code>。<br>「另外」在MIPS机器上不对齐会报错。<br>「水深」字节对齐不但牵涉硬件，还有关大小端、强制转化等隐蔽错误！<br>「关于那个somehow」网上看了很多资料，都没有很好从硬件上解释CPU为何会先从4B的整数位置开始，只能somehow了。。。</p>
<h4 id="对齐规则"><a href="#对齐规则" class="headerlink" title="对齐规则"></a>对齐规则</h4><p>非常类似于「内存分页」。规则如下：</p>
<ol>
<li>变量长度<code>大于等于</code>4B的，一律另开一个槽（页），从4B的整数地址开始。</li>
<li>变量长度<code>小于</code>4B的，先试下能否直接在前面变量的槽里塞下，塞的下就塞进去。塞不下就另开一个槽。</li>
</ol>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> A&#123;</span><br><span class="line">	<span class="keyword">char</span> a;</span><br><span class="line">	<span class="keyword">short</span> b;</span><br><span class="line">	<span class="keyword">int</span> c;</span><br><span class="line">&#125;;   <span class="comment">//sizeof为8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> B&#123;</span><br><span class="line">	<span class="keyword">char</span> a;</span><br><span class="line">	<span class="keyword">int</span> c;</span><br><span class="line">	<span class="keyword">short</span> b;</span><br><span class="line">&#125;;   <span class="comment">//sizeof为12</span></span><br></pre></td></tr></table></figure>
<h4 id="写在最后：对齐方式可以改吗？"><a href="#写在最后：对齐方式可以改吗？" class="headerlink" title="写在最后：对齐方式可以改吗？"></a>写在最后：对齐方式可以改吗？</h4><p>当然可以的，改大了浪费空间，改小了影响效率，一般就是默认就行了。<br>默认值一般是CPU的字长。<br>修改方式：<br><code>#pragma pack(4) //按4字节对齐</code></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/20/C++零碎笔记/" class="prev">上一篇</a><a href="/2016/02/02/iOS和OSX小技巧/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://Rocklu.me">Rock Lu</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>